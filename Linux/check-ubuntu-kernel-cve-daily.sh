#!/bin/bash

# This script was meant to be use to tell "if there is a new Kernel CVE(s) published by Ubuntu Canonical"
# Script requires an archived file to compare with the latest file from Ubuntu Canonical.
# Script will exit out if it did not find an existing archived HTML file and will download the latest for next run.
# Script will delete the archived html file and will save the latest html file as an archive which will be deleted next run.

# URLs
ALL_CVE_URL="https://ubuntu.com/security/cves?q=&package=&priority=&version=bionic&status="
KERNEL_CVE_URL="https://ubuntu.com/security/cves?q=&package=linux&priority=&version=bionic&status="
URL=${KERNEL_CVE_URL}

# INPUT parameters
# "while getopts 'a' flag" vs. "while getopts 'a:' flag" << the later required passing a parameter
# while getopts 'a' flag
# do
#     case "${flag}" in
#         a) URL=${ALL_CVE_URL}
#         ;;
#     esac
# done

# Name of file that was last save
ARCHIVE_FILE_PATH=$(find . -type f -name "ubuntu-cve-*.html")

# Download the html file
HTML_FILE_NAME=ubuntu-cve-$(date '+%Y-%m-%d-%H:%M:%S').html
wget -q -O ${HTML_FILE_NAME} "${URL}" > /dev/null

# Check if file exist
test -f "${ARCHIVE_FILE_PATH}"
ARCHIVE_FILE_STATUS=$?

if [[ ${ARCHIVE_FILE_STATUS} -eq 0 ]];then
    :
else
    echo "[Warning] NO archived file was found - i.e. no file to compare the latest Ubuntu html with."
    echo "The lastest HTML has been downloaded. Next run should be OK."
    exit 1
fi

# Compare the latest html and the last one
diff -s ${ARCHIVE_FILE_PATH} ${HTML_FILE_NAME} > /dev/null
status=$?
[ $status -eq 0 ] && echo "NO new Kernel CVE had been pusblished" || echo "New Kernel CVE(s) was published"

# Remove the old archived file
# echo "diff return status -> ${status}"
# echo "ARCHIVE_FILE_NAME -> ${ARCHIVE_FILE_PATH}"
# echo "LATEST_FILE_NAME -> ${HTML_FILE_NAME}"
rm -f ${ARCHIVE_FILE_PATH}

# Look for number of CVE results
NUMBER_OF_CVE=$(grep "[0-9] results" ${HTML_FILE_NAME})
echo "Number of CVEs -> ${NUMBER_OF_CVE}"
